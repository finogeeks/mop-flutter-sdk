# 1小程序预加载

### 1.1 需要Flutter支持小程序预加载API

iOS:

```
/**
 @brief 批量更新小程序
 @param appIds 小程序id数组
 @param apiServer 服务器地址
 @param complete 批量更新小程序回调
 */
- (void)downloadApplets:(NSArray *)appIds apiServer:(NSString *)apiServer complete:(void (^)(NSArray *results, FATError *error))complete;

/**
 @brief 批量更新小程序
 @param appIds 小程序id数组
 @param apiServer 服务器地址
 @param isBatchDownloadApplets 是否下载小程序
 @param complete 批量更新小程序回调
 */
- (void)downloadApplets:(NSArray *)appIds apiServer:(NSString *)apiServer isBatchDownloadApplets:(BOOL)isBatchDownloadApplets complete:(void (^)(NSArray *results, FATError *error))complete;

```



Android:

```
/**
 * 批量下载小程序到本地
 * @param context [Context]实例
 * @param apiServer 小程序所在应用市场的服务器地址
 * @param appIds 需要下载的小程序id数组
 * @param callback 结果回调
 * 注意：回调结果对象[AppletDownLoadInfo]字段
         @param appId       被下载的小程序id 
         @param success     小程序是否获取成功
         @param needUpdate  是否需要更新本地小程序  true:小程序来源于网络 ; false:小程序本地已经是最新版无需下载 （此字段只有 success 为 true 的时候才有意义）
 */
fun downloadApplets(context: Context ,apiServer:String ,appIds: List<String>,callback: FinSimpleCallback<List<AppletDownLoadInfo>>)
 
        已复制代码
    
/**
 * 批量下载小程序到本地
 * @param context [Context]实例
 * @param apiServer 小程序所在应用市场的服务器地址
 * @param appIds 需要下载的小程序id数组
 * @param isBatchDownloadApplets 获取小程序详情后是否下载这些小程序
 * @param callback 结果回调
 * 注意：回调结果对象[AppletDownLoadInfo]字段
         @param appId       被下载的小程序id 
         @param success     小程序是否获取成功
         @param needUpdate  是否需要更新本地小程序  true:小程序来源于网络 ; false:小程序本地已经是最新版无需下载 （此字段只有 success 为 true 的时候才有意义）
 */
fun downloadApplets(context: Context ,apiServer:String ,appIds: List<String>, isBatchDownloadApplets: Boolean, callback: FinSimpleCallback<List<AppletDownLoadInfo>>)

```



# 3 搜索小程序

### 3.1 需要Flutter支持搜索小程序

iOS:

```
/// 搜索小程序
/// @param request 搜索的request
/// @param completion 搜索结果
- (void)searchAppletsWithRequest:(FATSearchAppletRequest *)request
                      completion:(void (^)(NSDictionary *result, FATError *aError))completion;
 
        已复制代码
    
示例代码：

FATSearchAppletRequest *searchRequest = [[FATSearchAppletRequest alloc] init];
searchRequest.apiServer = @"https://api.finclip.com";
searchRequest.text = @"小程序";
[[FATClient sharedClient] searchAppletsWithRequest:searchRequest completion:^(NSDictionary *result, FATError *aError) {
    NSLog(@"");
}];
```



Android:

```
/**
 * 搜索小程序
 *
 * @param searchAppletRequest 请求体
 * @param callback 请求结果回调
 */
fun searchApplet(
    searchAppletRequest: SearchAppletRequest,
    callback: FinCallback<SearchAppletResponse>
)
 
        已复制代码
    
SearchAppletRequest说明：

/**
 * 搜索小程序请求实体类
 *
 * @param apiServer 服务器地址
 * @param text 搜索内容
 */
data class SearchAppletRequest(var apiServer: String,
                               var text: String)
 
        已复制代码
    
SearchAppletResponse说明：

/**
 * 搜索小程序返回实体类
 *
 * @param list 搜索到的小程序集合
 * @param total 搜索到的小程序数量
 */
data class SearchAppletResponse(
        val list: List<AppletInfo>?,
        val total: Int
)

/**
 * 搜索小程序返回的小程序信息实体类
 *
 * @param appId 小程序id
 * @param appName 小程序名称
 * @param desc 小程序描述信息
 * @param highLights 高亮字体
 * @param logo 小程序logo
 * @param organName 企业名称
 * @param pageUrl 小程序搜索到的页面路径
 * @param showText 展示内容
 */
data class AppletInfo(
        val appId: String?,
        val appName: String?,
        val desc: String?,
        val highLights: List<HighLight>?,
        val logo: String?,
        val organName: String?,
        val pageUrl: String?,
        val showText: String?
)

/**
 * 高亮字体
 *
 * @param key 高亮字体的key
 * @param value 高亮字体的value
 */
data class HighLight(
        val key: String?,
        val value: String?
)
 
        已复制代码
    
#调用示例
Kotlin
Java
FinAppClient.appletApiManager.searchApplet(
    SearchAppletRequest("服务地地址", "搜索内容"),
    object : FinCallback<SearchAppletResponse> {
        override fun onSuccess(result: SearchAppletResponse?) {
            // 搜索成功
        }

        override fun onError(code: Int, error: String?) {
            // 搜索失败
        }

        override fun onProgress(status: Int, info: String?) {
        }
    })
 
```



# 4. 最近使用的小程序

### 4.1 需要Flutter支持最近使用的小程序

iOS:

```
/**
 获取本地的小程序
 
 @return 小程序数组<FATAppletInfo>
 */
- (NSArray *)getAppletsFromLocalCache;

```



Android:

```
/**
 * 获取所有使用过的小程序
 */
fun getUsedApplets(): List<FinApplet>
 
        已复制代码
    
#调用示例
Kotlin
Java
val usedApplets = FinAppClient.appletApiManager.getUsedApplets() 
```



# 5. 小程序路径转化为绝对路径

### 5.1 finfile路径转换为绝对路径

iOS:

```
在有些场景下，我们拿到小程序的finfile文件路径，需要转换成沙盒路径，这时可以用该方法转换为沙盒路径。

该api，是fat_absolutePathWithPath:的升级版本，转换绝对路径更加灵活。即使小程序未运行，finfile文件不存在，也能够将finfile路径转换为绝对路径。使用该api可以更加灵活的往小程序目录下保存文件。

/// 将finfile路径转换成真实路径,如果传入的finfilePath不是finfile协议，返回nil
/// appletId 小程序id，可不传；不传时会去获取当前小程序id(有可能为空)
/// @param finfilePath  finfile路径
/// @param needFileExist  是否需要文件存在，传YES，如果传入的finfile路径的文件不存在，返回nil；传NO，不管文件是否存在，都返回对应的路径
- (NSString *)absolutePathWithAppletId:(NSString *_Nullable)appletId finFilePath:(NSString *)finfilePath needFileExist:(BOOL)needFileExist;
 
        已复制代码
    
示例代码：

NSString *finfilePath = @"finfile://tmp_7C82E6C26B7627334E88355E9D286621.mp4";
NSString *path = [[FATClient sharedClient] absolutePathWithAppletId:@"小程序id" finFilePath:finfilePath needFileExist:YES];
 
```

Android:

```
在有些场景下，我们拿到finfile的文件路径，但此时路径下文件并不实际存在，希望转换为绝对路径后，将文件存进去使用。

比如，我们希望把图片保存在小程序的路径下，这时可以先调用API：generateFinFilePath，生成finfile路径，再调用此API生成绝对路径(如：生成finfile://usr/bbc/bbab/test.jpg的绝对路径，转换为绝对路径后前两级目录bbc/bbab/，此API将会自动生成) 。生成绝对路径后，可以把图片文件存到此路径下。

    /**
     *  把finfile文件路径转换为绝对路径
     *  @param context
     *  @param appId
     *  @param filePath  finfile文件路径
     */
    fun getFinFileAbsolutePathCanNoExist(context: Context, appId: String, filePath: String): String?

 
        已复制代码
    
#调用示例
val appletTempPath = FinAppClient.appletApiManager.getFinFileAbsolutePathCanNoExist(this,"60964a900f0ca30001292da1","finfile://usr/bbc/bbab/test.jpg")
 
```



### 5.2 生成finfile协议路径

iOS:

```
小程序中的finfile协议路径有三种：finfile://tmp_ 、finfile://store_、finfile://usr/。tmp类型路径是保存在小程序运行目录下，下次冷启动小程序时会被清除；store路径会持久化保存，当删除小程序时才会删除；usr类型路径也会持久化保存，但是只可以自定义文件名以及保存目录。

该函数，可以传入文件名和要保存的路径类型，生成一个finfile协议路径，以供小程序中使用。但是文件不一定存在，要结合其他api，往对应文件内协议内容。


/**
 生成finfile协议路径
 
 @param fileName 文件名。pathType为FATFinFileDirUsr时，支持文件夹，如/aaa/abc.jpg，其他类型不支持带路径
 @param pathType Finfile的目录类型，详情参考FATFinFilePathType
 @return finfile协议的路径
 */
- (NSString *)generateFinFilePath:(NSString *)fileName pathType:(FATFinFilePathType)pathType;
 
        已复制代码
    
示例代码：

NSString *filePath = @"abc.txt";
NSString *finfilepath = [[FATClient sharedClient] generateFinFilePath:filePath pathType:FATFinFilePathTmp];

// 返回值：finfile://tmp_b118e2e5e2618d4d8bbbb7b0a3ad806a.txt
 
```

Android:

```
小程序中的finfile协议路径有三种：finfile://tmp_ 、finfile://store_、finfile://usr/。tmp类型路径是保存在小程序运行目录下，下次冷启动小程序时会被清除；store路径会持久化保存，当删除小程序时才会删除；usr类型路径也会持久化保存，但是只可以自定义文件名以及保存目录。

该函数，可以传入文件名和要保存的路径类型，生成一个finfile协议路径，以供小程序中使用。但是文件不一定存在，要结合其他api，往对应文件内协议内容。

     /**
     * 根据路径类型生成FinFile协议格式的路径
     * @param filePath 文件路径，当pathType为usr类型时，支持文件夹，比如/aaa/bbb.jpg
     * @param pathType 路径类型, 这是一个枚举变量 usr, tmp, store
     */
    fun generateFinFilePath(filePath: String, pathType: FinFilePathType): String?
 
        已复制代码
    
#调用示例
val appletTempPath = FinAppClient.appletApiManager.generateFinFilePath("bbc/bbab/test.jpg", FinFilePathType.USR)
 
```



# 6. 小程序移动到前台

### 6.1 需要flutter支持小程序移动到前台（安卓端）



Android:

```
```





# 7.获取小程序的收藏列表

### 7.1 更新小程序的收藏状态

iOS:

```
///  更新小程序的收藏状态
/// @param appletId  小程序id
/// @param favorite  收藏状态
/// @param complete 结果回调，error为nil表示更新成功
+ (void)updateApplet:(NSString *)appletId favoriteStatus:(BOOL)favorite withComplete:(void(^)(NSError *error,FATAppletInfo *appletInfo))complete;
 
        已复制代码
    
示例代码：

[FATMoreMenuHelper updateApplet:@"6007a0a122bad000012813eb" favoriteStatus:YES withComplete:^(NSError *error, FATAppletInfo *appletInfo) {
    if (error) {
                
    } else {
                
    }
}];
 
```

Android:

```
/**
 * 更新小程序收藏状态
 *
 * @param favorite true 收藏，false 取消收藏
 */
fun updateAppletFavoriteState(
    context: Context,
    favorite: Boolean,
    callback: FinCallback<Any?>
)
 
        已复制代码
    
示例代码：

MoreMenuHelper.updateAppletFavoriteState(this, true, object : FinCallback<Any?> {
    override fun onSuccess(result: Any?) {
    }

    override fun onError(code: Int, error: String?) {
    }

    override fun onProgress(status: Int, info: String?) {
    }
})
 
```



### 7.2 获取小程序的收藏状态



iOS:

```
/// 获取小程序是否已收藏
/// @param appletId  小程序id
+ (BOOL)isAppletFavorite:(NSString *)appletId;
 
        已复制代码
    
示例代码：

BOOL favorite = [FATMoreMenuHelper isAppletFavorite:@"6007a0a122bad000012813eb"];
```

Android:

```
/**
 * 获取当前小程序的收藏状态
 *
 * @return 返回null表示未获取到状态
 */
fun isAppletFavorite(context: Context): Boolean?
 
        已复制代码
    
示例代码：

MoreMenuHelper.isAppletFavorite(context)
 
```



### 7.3 获取小程序的收藏列表

iOS:

```
/**
 @brief 获取小程序收藏列表
 @param apiServer 服务器地址
 @param pageNo 页码（传0则获取全部收藏小程序）
 @param pageSize 页大小（传0则获取全部收藏小程序）
 @param completion 获取小程序收藏列表回调
 */
- (void)getAppletFavoriteListWithApiServer:(NSString *)apiServer pageNo:(int)pageNo pageSize:(int)pageSize completion:(void (^)(NSDictionary *resultDict, FATError *error))completion;

```

Android:

```
    /**
     * 获取收藏的小程序列表
     *
     * @param favoriteAppletListRequest 请求体
     * @param callback 请求结果回调
     */
    fun getFavoriteApplets(
        favoriteAppletListRequest: FavoriteAppletListRequest,
        callback: FinCallback<FavoriteAppletListResp>
    )
 
        已复制代码
    
示例代码：

val request = FavoriteAppletListRequest("https://api.finclip.com", 1, 5)
            FinAppClient.appletApiManager.getFavoriteApplets(request, object: FinSimpleCallback<FavoriteAppletListResp>() {
                override fun onSuccess(result: FavoriteAppletListResp) {
                    Toast.makeText(application, "getFavoriteApplets onSuccess : $result", Toast.LENGTH_SHORT).show()
                }

                override fun onError(code: Int, error: String?) {
                    Toast.makeText(application, "getFavoriteApplets onError", Toast.LENGTH_SHORT).show()
                }
            })
 
```



# 8. 小程序灰度扩展

### 8.1 需要Flutter支持配置灰度扩展参数

iOS:

```
/// 小程序灰度扩展参数
/// @param appletId 小程序id
- (NSDictionary *)grayExtensionWithAppletId:(NSString *)appletId;
 
        已复制代码
    
示例代码：

- (NSDictionary *)grayExtensionWithAppletId:(NSString *)appletId
{
    NSDictionary *grayExtension = @{@"key11":@"value1",@"key12":@"value2"};
    if ([appletId isEqualToString:@"5e017a61c21ecf0001343e31"]) {
        grayExtension = @{@"fckey1":@"fcvalue1"};
    }
    return grayExtension;
}
 
```

Android:

```
怎样配置灰度发布规则？
答：和通过抽象业务回调接口IAppletHandler实现小程序分享一样， 灰度发布配置参数的注入也是通过IAppletHandler来实现的，IAppletHandler会把获取灰度发布配置参数的接口方法getGrayAppletVersionConfigs回调给宿主应用，由宿主应用实现具体的业务逻辑。

getGrayAppletVersionConfigs如下：

/**
 * 获取灰度发布配置参数
 *
 * @param appId 小程序ID
 * @return 灰度发布配置参数
 */
fun getGrayAppletVersionConfigs(appId: String): List<GrayAppletVersionConfig>?
 
        已复制代码
    
同样，IAppletHandler实例需要通过调用IAppletApiManager的setAppletHandler(appletHandler: IAppletHandler)方法传入。
```



